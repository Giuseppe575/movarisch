<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MOVARISCH ‚Äì SDS Parser (PDF ‚Üí Tabella ‚Üí Excel)</title>
<!-- Stilizzazione minima ma pulita -->
<style>
  :root { --bg:#0b1220; --card:#121a2b; --muted:#9fb0cf; --ink:#e8eefc; --accent:#7aa2ff; --ok:#1fb26b; --mod:#f0ad4e; --high:#e05260; }
  *{box-sizing:border-box}
  body{margin:0; font:14px/1.4 system-ui,Segoe UI,Roboto,Arial; color:var(--ink); background:linear-gradient(180deg,#0b1220,#0d1627);} 
  header{padding:24px; border-bottom:1px solid #1d2a44; background:rgba(0,0,0,.15); position:sticky; top:0; backdrop-filter: blur(8px);} 
  h1{margin:0 0 6px; font-size:22px}
  p.sub{margin:0; color:var(--muted)}
  main{padding:20px; max-width:1200px; margin:0 auto}
  .card{background:var(--card); border:1px solid #1d2a44; border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .risk-legend{margin-top:14px; display:grid; gap:10px}
  .risk-legend .legend-title{font-weight:600; letter-spacing:.3px; text-transform:uppercase; font-size:12px; color:var(--muted)}
  .risk-legend .legend-grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .risk-legend .legend-item{background:#0e1a33; border:1px solid #273756; border-radius:12px; padding:10px; display:grid; gap:8px}
  .risk-legend .legend-range{font-weight:600; color:var(--ink)}
  .risk-legend .badge{height:100%; text-align:left}
  .default-note{margin:0; font-size:12px; color:var(--muted)}
  label.btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; background:#0e1a33; border:1px solid #1d2a44; border-radius:10px; cursor:pointer}
  input[type=file]{display:none}
  input[type=number], input[type=text], select{background:#0e1a33; border:1px solid #273756; color:var(--ink); padding:8px 10px; border-radius:8px}
  select{appearance:none; -webkit-appearance:none; min-width:160px}
  .btn{padding:10px 14px; border-radius:10px; border:1px solid #273756; background:#0e1a33; color:var(--ink); cursor:pointer}
  .btn.primary{background:var(--accent); color:#0a1020; border-color:transparent; font-weight:600}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  table{width:100%; border-collapse:collapse; margin-top:12px}
  th, td{border:1px solid #2a3a5a; padding:8px; vertical-align:top}
  th{background:#0e1830; position:sticky; top:84px; z-index:2}
  td.num, th.num{text-align:right}
  td.edit{background:#0f1c38}
  .badge{padding:6px 10px; border-radius:12px; font-weight:600; display:block; line-height:1.3}
  .b-irr{background:rgba(31,178,107,.18); color:var(--ok); border:1px solid rgba(31,178,107,.35)}
  .b-unc{background:rgba(240,173,78,.18); color:var(--mod); border:1px solid rgba(240,173,78,.4)}
  .b-sup{background:rgba(224,82,96,.18); color:#ff616f; border:1px solid rgba(224,82,96,.45)}
  .b-elev{background:rgba(197,82,224,.18); color:#e89eff; border:1px solid rgba(197,82,224,.45)}
  .b-grave{background:rgba(168,32,32,.22); color:#ff8f8f; border:1px solid rgba(168,32,32,.55)}
  footer{color:var(--muted); text-align:center; padding:18px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  #alert{display:none;margin-top:10px;padding:10px 12px;border:1px solid #5b1b1b;background:#2a0b0b;color:#ffd7d7;border-radius:8px}
</style>
<!-- Librerie: SheetJS e PDF.js (UMD). -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
if(window.pdfjsLib){
  try{ window.pdfjsLib.GlobalWorkerOptions.workerSrc='https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js'; }catch(e){}
}
</script>
</head>
<body>
<header>
  <h1>MOVARISCH ‚Äì Parser SDS da PDF</h1>
  <p class="sub">Carica le SDS/TDS in PDF ‚Üí estrazione H/EUH ‚Üí calcolo MOVARISCH ‚Üí esporta Excel</p>
</header>

<main>
  <section class="card">
    <div class="row">
      <label class="btn">
        <input type="file" id="pdfInput" accept="application/pdf" multiple />
        üìÑ Seleziona PDF SDS/TDS
      </label>
      <button class="btn" id="parseBtn" disabled>üîç Estrai & Calcola</button>
      <button class="btn" id="clearBtn">‚ôªÔ∏è Svuota</button>
      <button class="btn" id="testBtn">üß™ Test libreria</button>
      <button class="btn primary" id="exportBtn" disabled>‚¨áÔ∏è Esporta Excel</button>
    </div>
    <div class="risk-legend">
      <span class="legend-title">Classificazione del giudizio</span>
      <div class="legend-grid">
        <div class="legend-item">
          <div class="legend-range">0,1 ‚â§ R &lt; 15</div>
          <span class="badge b-irr">Irrilevante per la salute</span>
        </div>
        <div class="legend-item">
          <div class="legend-range">15 ‚â§ R &lt; 21</div>
          <span class="badge b-unc">Intervallo di incertezza<br/>E‚Äô necessario, prima della classificazione in rischio irrilevante per la salute, rivedere con scrupolo l‚Äôassegnazione dei vari punteggi, rivedere le misure di prevenzione e protezione adottate e consultare il medico competente per la decisione finale.</span>
        </div>
        <div class="legend-item">
          <div class="legend-range">21 ‚â§ R ‚â§ 40</div>
          <span class="badge b-sup">Rischio superiore al rischio chimico irrilevante per la salute<br/>Applicare gli articoli 225, 226, 229 e 230 D. Lgs 81/08 e s.m.i.</span>
        </div>
        <div class="legend-item">
          <div class="legend-range">40 &lt; R ‚â§ 80</div>
          <span class="badge b-elev">Rischio elevato</span>
        </div>
        <div class="legend-item">
          <div class="legend-range">R &gt; 80</div>
          <span class="badge b-grave">Rischio grave<br/>Riconsiderare il percorso dell‚Äôidentificazione delle misure di prevenzione e protezione ai fini di una loro eventuale implementazione. Intensificare i controlli quali la sorveglianza sanitaria, la misurazione degli agenti chimici e la periodicit√† della manutenzione.</span>
        </div>
      </div>
      <p class="mono default-note">Default indici ‚Üí I=3, DIS=0.75, E<sub>cut</sub>=1.0</p>
    </div>
    <div id="alert"></div>
  </section>

  <section class="card" style="margin-top:14px">
    <table id="tbl">
      <thead>
        <tr>
          <th>File</th>
          <th>Nome commerciale</th>
          <th>Stato fisico</th>
          <th>H-codes (estratti)</th>
          <th class="num">SCORE</th>
          <th>Tipologia d'uso</th>
          <th>Tipologia di controllo</th>
          <th>Tempo di esposizione</th>
          <th>Quantit√† in uso</th>
          <th class="num">D</th>
          <th class="num">U</th>
          <th class="num">C</th>
          <th class="num">I</th>
          <th class="num">DIS</th>
          <th class="num">E<sub>inal</sub></th>
          <th class="num">E<sub>cut</sub></th>
          <th class="num">R<sub>inal</sub></th>
          <th class="num">R<sub>cut</sub></th>
          <th class="num">R<sub>tot</sub></th>
          <th>Giudizio</th>
          <th>‚Äî</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<footer>
  ¬© MOVARISCH Tool ‚Äì uso interno consulenza. Tutto offline nel browser. Nessun upload a server.
</footer>

<script>
// =================== CONFIG ===================
const H_SCORE = {
  "H332":4.50,"H312":3.00,"H302":2.00,"H331":6.00,"H311":4.50,"H301":2.25,
  "H330":6.50,"H330 cat.1":6.50,"H330 cat.2":5.50,
  "H310":3.00,"H310 cat.1":3.00,"H310 cat.2":2.50,
  "H300":3.00,"H300 cat.1":3.00,"H300 cat.2":8.50,
  "EUH029":3.00,"EUH031":3.50,"EUH032":6.25,
  "H314":5.50,"H314 cat.1A":5.75,"H314 cat.1B":5.50,"H314 cat.1C":2.50,
  "H315":4.50,"H318":3.00,"H319":3.00,"EUH066":2.50,
  "H334":8.50,"H334 cat.1A":9.00,"H334 cat.1B":8.00,
  "H317":4.50,"H317 cat.1A":6.00,"H317 cat.1B":4.50,
  "H370":9.50,"H371":8.00,"H335":3.25,"H336":3.50,
  "H372":8.00,"H373":7.00,"H304":3.50,
  "H360":10.00,"H360D":9.50,"H360Df":9.75,"H360F":9.50,"H360FD":10.00,
  "H341":8.00,"H351":8.00,"H361":8.00,"H361d":7.50,"H361f":7.50,"H361fd":8.00,
  "H362":6.00,
};
const UV_FALLBACK = ["H317","H335"]; // per UV/acrilati quando H non rilevate
const REGEX_H = /(EUH\d{3}|H\d{3})(?:\s*cat\.?\s*(1A|1B|1|2))?/gi;

const SISTEMA_OPTIONS = [
  { value:'chiuso', label:'Sistema chiuso', baseIndex:1.5 },
  { value:'controllato', label:'Uso controllato', baseIndex:2.0 },
  { value:'dispersivo', label:'Sistema dispersivo', baseIndex:2.5 },
  { value:'matrice', label:'Incluso nella matrice', baseIndex:1.0 },
];

const CONTROL_TYPE_OPTIONS = [
  { value:'contenimento_completo', label:'Contenimento completo' },
  { value:'aspirazione_localizzata', label:'Aspirazione localizzata' },
  { value:'segregazione_separazione', label:'Segregazione - separazione' },
  { value:'ventilazione_generale', label:'Ventilazione generale' },
  { value:'manipolazione_diretta', label:'Manipolazione diretta' },
];

const EXPOSURE_TIME_OPTIONS = [
  { value:'lt_15', label:'< 15 minuti' },
  { value:'15_2', label:'15 minuti e 2 ore' },
  { value:'2_4', label:'2 ore - 4 ore' },
  { value:'4_6', label:'4 ore - 6 ore' },
  { value:'gt_6', label:'> 6 ore' },
];

const QUANTITY_OPTIONS = [
  { value:'lt_0_1', label:'< 0,1 Kg', increment:0.5 },
  { value:'0_1_1', label:'tra 0,1 e 1 Kg', increment:1.0 },
  { value:'1_10', label:'tra 1 e 10 Kg', increment:1.5 },
  { value:'10_100', label:'tra 10 e 100 Kg', increment:2.0 },
  { value:'gt_100', label:'> 100 Kg', increment:2.5 },
];

const STATO_FISICO_OPTIONS = [
  { value:'solido', label:'Solido' },
  { value:'liquido', label:'Liquido' },
  { value:'gassoso', label:'Gassoso' },
];

const defaults = {
  sistema:'controllato',
  controlType:'aspirazione_localizzata',
  exposureTime:'15_2',
  qtyBand:'1_10',
  statoFisico:'liquido',
  D:3, U:3, C:3, I:3, DIS:0.75, Ecut:1.0
};

const RISK_CLASSES = [
  {
    id:'irr',
    test:(r)=> r < 15,
    text:'Irrilevante per la salute'
  },
  {
    id:'unc',
    test:(r)=> r >= 15 && r < 21,
    text:'Intervallo di incertezza\nE\u2019 necessario, prima della classificazione in rischio irrilevante per la salute, rivedere con scrupolo l\u2019assegnazione dei vari punteggi, rivedere le misure di prevenzione e protezione adottate e consultare il medico competente per la decisione finale.'
  },
  {
    id:'sup',
    test:(r)=> r >= 21 && r <= 40,
    text:'Rischio superiore al rischio chimico irrilevante per la salute\nApplicare gli articoli 225, 226, 229 e 230 D. Lgs 81/08 e s.m.i.'
  },
  {
    id:'elev',
    test:(r)=> r > 40 && r <= 80,
    text:'Rischio elevato'
  },
  {
    id:'grave',
    test:(r)=> r > 80,
    text:'Rischio grave\nRiconsiderare il percorso dell\u2019identificazione delle misure di prevenzione e protezione ai fini di una loro eventuale implementazione. Intensificare i controlli quali la sorveglianza sanitaria, la misurazione degli agenti chimici e la periodicit√† della manutenzione.'
  }
];

// =================== STATE ===================
const state = { files:[], rows:[] };
const $ = s => document.querySelector(s);

// =================== LIB LOADER + ALERT ===================
function showAlert(msg){ const el=$('#alert'); el.textContent=msg; el.style.display='block'; }
function clearAlert(){ const el=$('#alert'); el.textContent=''; el.style.display='none'; }

async function loadScript(src){
  return new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = () => resolve();
    s.onerror = (err) => {
      s.remove();
      reject(err || new Error('Impossibile caricare '+src));
    };
    document.head.appendChild(s);
  });
}

async function ensureXlsx(){
  if(window.XLSX){ return window.XLSX; }
  const urls = [
    'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
    'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'
  ];
  let lastErr;
  for(const url of urls){
    try{
      await loadScript(url);
      if(window.XLSX){ break; }
    }catch(err){
      lastErr = err;
    }
  }
  if(!window.XLSX){
    throw lastErr || new Error('Impossibile caricare la libreria Excel (SheetJS).');
  }
  return window.XLSX;
}

async function ensurePdfJs(){
  if(window.pdfjsLib){ return window.pdfjsLib; }
  const urls = [
    'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js'
  ];
  for(const u of urls){
    try{
      await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=u; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
      if(window.pdfjsLib){ break; }
    }catch(e){}
  }
  if(!window.pdfjsLib){ throw new Error('Impossibile caricare PDF.js. Verifica la connessione o le policy di rete.'); }
  try{ window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js'; }catch(e){}
  return window.pdfjsLib;
}

// =================== PDF TEXT EXTRACTION ===================
function readAsArrayBuffer(file){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = () => reject(fr.error || new Error('Impossibile leggere il file'));
    fr.readAsArrayBuffer(file);
  });
}

async function pdfToText(file){
  const pdfjs = await ensurePdfJs();
  // Evita fetch su blob:URL (pu√≤ fallire nel sandbox) passando i bytes direttamente
  const data = await readAsArrayBuffer(file);
  let pdf;
  try{
    pdf = await pdfjs.getDocument({data}).promise;
  }catch(err){
    // Fallback: disabilita worker e riprova
    try{ pdfjs.disableWorker = true; }catch(e){}
    pdf = await pdfjs.getDocument({data}).promise;
  }
  let full = '';
  for(let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const txt = await page.getTextContent();
    const str = txt.items.map(it=>it.str).join(' ');
    full += '\n'+str;
  }
  return full;
}

function findH(text){
  const out=[]; const seen=new Set();
  for(const m of text.matchAll(REGEX_H)){
    const base=(m[1]||'').toUpperCase();
    const cat=(m[2]||'').toUpperCase().replace(/\s+/g,'');
    let code=base;
    if(cat){
      if(/^H(314|330|310|300)$/i.test(base) && /^(1A|1B|1C|1|2)$/.test(cat)) code = base+' cat.'+cat;
      if(/^H(334|317)$/i.test(base) && /^(1A|1B)$/.test(cat)) code = base+' cat.'+cat;
    }
    if(!seen.has(code)){ seen.add(code); out.push(code); }
  }
  return out;
}

const PRODUCT_LINE_PATTERNS = [
  { regex:/nome\s+commerciale\s*(?:[:\-‚Äì]\s*)?(.+)/i, priority:100, type:'name' },
  { regex:/nome\s+del\s+prodotto\s*(?:[:\-‚Äì]\s*)?(.+)/i, priority:95, type:'name' },
  { regex:/nome\s+prodotto\s*(?:[:\-‚Äì]\s*)?(.+)/i, priority:90, type:'name' },
  { regex:/denominazione\s+del\s+prodotto\s*(?:[:\-‚Äì]\s*)?(.+)/i, priority:85, type:'name' },
  { regex:/denominazione\s*(?:[:\-‚Äì]\s*)?(.+)/i, priority:80, type:'name' },
  { regex:/product\s+trade\s+name\s*(?:[:\-‚Äì]\s*)?(.+)/i, priority:75, type:'name' },
  { regex:/product\s+name\s*(?:[:\-‚Äì]\s*)?(.+)/i, priority:70, type:'name' },
  { regex:/trade\s+name\s*(?:[:\-‚Äì]\s*)?(.+)/i, priority:65, type:'name' },
  { regex:/commercial\s+name\s*(?:[:\-‚Äì]\s*)?(.+)/i, priority:60, type:'name' },
  { regex:/identificatore\s+del\s+prodotto\s*(?:[:\-‚Äì]\s*)?(.+)/i, priority:58, type:'identifier' },
  { regex:/product\s+identifier\s*(?:[:\-‚Äì]\s*)?(.+)/i, priority:25, type:'identifier' },
];

const PRODUCT_LABEL_ONLY = /(nome\s+commerciale|nome\s+del\s+prodotto|nome\s+prodotto|denominazione\s+del\s+prodotto|denominazione|identificatore\s+del\s+prodotto|product\s+trade\s+name|product\s+name|trade\s+name|commercial\s+name)\b/i;

const PRODUCT_STOP_WORDS = [
  'USO','USI','USE','USES','UTILIZZO','UTILIZATION','IDENTIFICATORE','IDENTIFIER','RELEVANT','IDENTIFIED','CAS','EC','INDEX','NUMERO','NUMBER','SUPPLIER','FORNITORE','COMPANY','MANUFACTURER','REGISTRATION','REGISTRAZIONE','EMERGENCY','TELEFONO','TELEPHONE','EMAIL','FAX','DETAILS','SAFETY DATA SHEET','SCHEDA DI SICUREZZA','SEZIONE','SECTION','1.2','1.3','1.4','2.1','2.2'
];

const SECTION11_START_REGEX = /^\s*1(?:\s*[\.,]\s*|\s+|[)\-‚Äì]\s*)1(?:\b|[\s:.-])/;
const SECTION11_END_REGEX = /^\s*(?:1(?:\s*[\.,\-‚Äì]\s*|\s+)(?:2|3|4|5|6|7|8|9)|1\.(?:2|3|4|5|6|7|8|9)|1,(?:2|3|4|5|6|7|8|9)|2(?:\b|[\s.:])|(?:SEZIONE|SECTION)\s*2\b)/i;

function cleanProductName(raw){
  if(!raw) return '';
  let name = raw.replace(/^[\s:;\-‚Äì]+/, '').replace(/\s+/g, ' ').trim();
  name = name.replace(/^(?:\d+\.\d+\s*)+/, '').trim();
  name = name.replace(/^(?:product\s+identifier|identificatore\s+del\s+prodotto)\s*/i, '').trim();
  name = name.replace(/^(?:product\s+trade\s+name|trade\s+name|commercial\s+name|nome\s+commerciale|denominazione\s+del\s+prodotto|denominazione|nome\s+del\s+prodotto|nome\s+prodotto)\s*/i, '').trim();
  name = name.replace(/^(?:o|or)\s+(?:designazione\s+della\s+miscela|designation\s+of\s+the\s+mixture)\s*/i, '').trim();
  name = name.replace(/^(?:designazione\s+della\s+miscela|designation\s+of\s+the\s+mixture)\s*/i, '').trim();
  if(!name) return '';
  const upper = name.toUpperCase();
  for(const stop of PRODUCT_STOP_WORDS){
    const idx = upper.indexOf(stop);
    if(idx > 3){
      name = name.slice(0, idx).trim();
      break;
    }
  }
  name = name.replace(/\b(?:details\s+of\s+the\s+supplier|fornitore\s+della\s+scheda\s+di\s+sicurezza|fornitore\s+del\s+la\s+scheda\s+di\s+sicurezza)\b.*$/i, '').trim();
  const sectionMatch = name.match(/\b\d+\.\d+\b/);
  if(sectionMatch && sectionMatch.index > 3){
    name = name.slice(0, sectionMatch.index).trim();
  }
  name = name.replace(/[\s:;\-‚Äì]+$/, '').trim();
  if(name.length > 120){
    name = name.slice(0, 120).trim();
  }
  return name;
}

function isValidProductName(name){
  if(!name) return false;
  if(name.length < 3) return false;
  if(!/[A-Z√Ä-√ñ√ò-√ù]/i.test(name)) return false;
  const trimmed = name.trim();
  if(/^(?:\d+\.\d+|SEZIONE|SECTION)\b/i.test(trimmed)) return false;
  if(/^(?:DETAILS|FORNITORE|SUPPLIER|RELEVANT|USI|USES|UTILIZZO|EMERGENCY)\b/i.test(trimmed)) return false;
  const upper = name.toUpperCase();
  if(/NOME\s+COMMERCIALE|NOME\s+DEL\s+PRODOTTO|PRODUCT\s+NAME|TRADE\s+NAME|COMMERCIAL\s+NAME|PRODUCT\s+IDENTIFIER/.test(upper)) return false;
  return true;
}

function nameQualityScore(name){
  if(!name) return -Infinity;
  let score = 0;
  const letters = (name.match(/[A-Z√Ä-√ñ√ò-√ùa-z√†-√∂√∏-√Ω]/g) || []).length;
  const digits = (name.match(/\d/g) || []).length;
  const hasSpace = /\s/.test(name);
  const hasLower = /[a-z√†-√∂√∏-√Ω]/.test(name);
  const tokenCount = name.trim().split(/\s+/).length;
  score += Math.min(letters, 60);
  if(hasSpace) score += 6;
  if(hasLower) score += 8;
  if(tokenCount >= 3) score += 4;
  if(/[;,:]/.test(name)) score -= 2;
  if(digits > letters) score -= 8;
  if(digits && !hasLower && letters <= digits + 2) score -= 6;
  if(/^[A-Z0-9;\-\s]+$/.test(name) && !hasLower) score -= 6;
  score -= Math.max(0, digits - 2);
  return score;
}

function collectCandidatesFromLines(lines, priorityBoost=0, indexOffset=0){
  const candidates = [];
  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    for(const pattern of PRODUCT_LINE_PATTERNS){
      const match = line.match(pattern.regex);
      if(match){
        const cleaned = cleanProductName(match[1]);
        if(isValidProductName(cleaned)){
          const basePriority = pattern.priority + priorityBoost;
          const quality = nameQualityScore(cleaned) - (pattern.type==='identifier' ? 5 : 0);
          candidates.push({ name: cleaned, priority: basePriority, quality, index:indexOffset + i });
        }
      }
    }
    if(PRODUCT_LABEL_ONLY.test(line) && i+1 < lines.length){
      const nextClean = cleanProductName(lines[i+1]);
      if(isValidProductName(nextClean)){
        const quality = nameQualityScore(nextClean);
        candidates.push({ name: nextClean, priority:68 + priorityBoost, quality, index:indexOffset + i + 1 });
      }
    }
  }
  return candidates;
}

function collectCandidatesFromText(text, priorityBoost=0, indexOffset=0){
  const candidates = [];
  if(!text) return candidates;
  for(const pattern of PRODUCT_LINE_PATTERNS){
    const match = text.match(pattern.regex);
    if(match){
      const cleaned = cleanProductName(match[1]);
      if(isValidProductName(cleaned)){
        const basePriority = pattern.priority + priorityBoost;
        const quality = nameQualityScore(cleaned) - (pattern.type==='identifier' ? 5 : 0);
        candidates.push({ name: cleaned, priority: basePriority, quality, index:indexOffset + candidates.length });
      }
    }
  }
  return candidates;
}

function extractSection11Lines(lines){
  const collected = [];
  let startIndex = -1;
  let capturing = false;
  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    const simplified = line.replace(/\s+/g, ' ').trim();
    const upper = simplified.toUpperCase();
    if(!capturing){
      if(SECTION11_START_REGEX.test(simplified) || upper.includes('1.1 IDENTIFICATORE DEL PRODOTTO') || upper.startsWith('IDENTIFICATORE DEL PRODOTTO') || upper.startsWith('PRODUCT IDENTIFIER')){
        capturing = true;
        if(startIndex === -1) startIndex = i;
        collected.push(line);
        continue;
      }
    }else{
      if(!simplified){
        collected.push(line);
        continue;
      }
      if(SECTION11_END_REGEX.test(simplified)){
        break;
      }
      collected.push(line);
    }
  }
  return { lines: collected, offset: startIndex < 0 ? 0 : startIndex };
}

function pickBestCandidate(candidates){
  if(!candidates.length) return '';
  candidates.sort((a,b)=>{
    if(b.priority !== a.priority) return b.priority - a.priority;
    if(b.quality !== a.quality) return b.quality - a.quality;
    return a.index - b.index;
  });
  return candidates[0].name;
}

function extractProductName(text){
  if(!text) return '';
  const normalized = text.replace(/\r/g, '\n');
  const lines = normalized.split(/\n+/).map(l=>l.trim());
  const sectionInfo = extractSection11Lines(lines);
  if(sectionInfo.lines.length){
    const sectionCandidates = collectCandidatesFromLines(sectionInfo.lines, 40, sectionInfo.offset);
    if(sectionCandidates.length){
      return pickBestCandidate(sectionCandidates);
    }
    const sectionText = sectionInfo.lines.join(' ');
    const sectionFallback = collectCandidatesFromText(sectionText, 35, sectionInfo.offset);
    if(sectionFallback.length){
      return pickBestCandidate(sectionFallback);
    }
  }
  const section2Match = normalized.match(/(?:^|\n)\s*(?:(?:SEZIONE|SECTION)\s*2\b|2(?:[\s\.:,\-]|$))/mi);
  const beforeSection2 = section2Match ? normalized.slice(0, section2Match.index) : normalized;
  const sectionOneLines = beforeSection2.split(/\n+/).map(l=>l.trim()).filter(Boolean);
  const sectionOneCandidates = collectCandidatesFromLines(sectionOneLines, 12, 0);
  if(sectionOneCandidates.length){
    return pickBestCandidate(sectionOneCandidates);
  }
  const fallbackText = beforeSection2.replace(/\s+/g, ' ');
  const fallbackCandidates = collectCandidatesFromText(fallbackText, 10, sectionOneLines.length);
  if(fallbackCandidates.length){
    return pickBestCandidate(fallbackCandidates);
  }
  if(sectionInfo.lines.length){
    const rawBlock = sectionInfo.lines.join(' ').replace(/\s+/g, ' ').trim();
    if(isValidProductName(rawBlock)){
      return rawBlock;
    }
  }
  return '';
}

function guessUV(fileName, text){
  const f = fileName.toUpperCase(); const t = text.toUpperCase();
  return f.includes('UV') || f.includes('VARNISH') || f.includes('OPTIFLEX') || f.includes('FLEXO') || f.includes('SCREEN') || t.includes(' UV ');
}

function pickScore(hcodes){
  if(!hcodes.length) return 0;
  const scores = hcodes.map(h=> H_SCORE[h] ?? H_SCORE[h.split(' ')[0]] ).filter(v=>typeof v==='number');
  return scores.length ? Math.max(...scores) : 0;
}

// =================== TABLE & CALC ===================
function recalcRow(row){
  row.Einal = round(row.I * row.DIS, 2);
  row.Rinal = round(row.SCORE * row.Einal, 2);
  row.Rcut  = round(row.SCORE * row.Ecut, 2);
  row.Rtot  = round(Math.sqrt(row.Rinal*row.Rinal + row.Rcut*row.Rcut), 2);
  const risk = classifyRisk(row.Rtot);
  row.Giudizio = risk.text;
  row.GiudizioClass = risk.id;
}

function render(){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  state.rows.forEach((r,i)=>{
    recalcRow(r);
    if(!r.statoFisico){ r.statoFisico = defaults.statoFisico; }
    if(!r.qtyBand){
      applyQuantity(r, undefined);
    }else if(!r.qty){
      r.qty = getQuantityOption(r.qtyBand)?.label ?? r.qtyBand;
    }
    if(!r.sistema){
      applySistema(r, undefined);
    }
    if(!r.controlType){
      r.controlType = defaults.controlType;
    }
    if(!r.exposureTime){
      r.exposureTime = defaults.exposureTime;
    }
    const tr = document.createElement('tr');
    const sistemaOptions = buildOptions(SISTEMA_OPTIONS, r.sistema);
    const controlOptions = buildOptions(CONTROL_TYPE_OPTIONS, r.controlType);
    const exposureOptions = buildOptions(EXPOSURE_TIME_OPTIONS, r.exposureTime);
    const qtyOptions = buildOptions(QUANTITY_OPTIONS, r.qtyBand);
    const statoOptions = buildOptions(STATO_FISICO_OPTIONS, r.statoFisico);

    tr.innerHTML = `
      <td>${escapeHtml(r.file)}</td>
      <td class="edit" data-field="nome" contenteditable>${escapeHtml(r.nome)}</td>
      <td><select data-stato>${statoOptions}</select></td>
      <td class="edit" data-field="hcodes" contenteditable>${escapeHtml(r.hcodes.join(';'))}</td>
      <td class="num edit" data-field="SCORE" contenteditable>${r.SCORE}</td>
      <td><select data-sistema>${sistemaOptions}</select></td>
      <td><select data-controllo>${controlOptions}</select></td>
      <td><select data-exposure>${exposureOptions}</select></td>
      <td><select data-qty>${qtyOptions}</select></td>
      <td class="num edit" data-field="D" contenteditable>${r.D}</td>
      <td class="num edit" data-field="U" contenteditable>${r.U}</td>
      <td class="num edit" data-field="C" contenteditable>${r.C}</td>
      <td class="num edit" data-field="I" contenteditable>${r.I}</td>
      <td class="num edit" data-field="DIS" contenteditable>${r.DIS}</td>
      <td class="num">${fmt(r.Einal)}</td>
      <td class="num edit" data-field="Ecut" contenteditable>${r.Ecut}</td>
      <td class="num">${fmt(r.Rinal)}</td>
      <td class="num">${fmt(r.Rcut)}</td>
      <td class="num"><b>${fmt(r.Rtot)}</b></td>
      <td>${badge(r.Giudizio, r.GiudizioClass)}</td>
      <td><button class="btn" data-del="${i}">x</button></td>`;

    tr.querySelectorAll('.edit').forEach((cell)=>{
      cell.addEventListener('input', ()=>{
        const field = cell.dataset.field;
        const value = cell.innerText.trim();
        if(field==='nome'){ r.nome = value; }
        else if(field==='hcodes'){ r.hcodes = value.split(';').map(s=>s.trim()).filter(Boolean); }
        else if(field==='SCORE'){ r.SCORE = toNum(value, r.SCORE); }
        else if(field==='D'){ r.D = toNum(value, r.D); }
        else if(field==='U'){ r.U = toNum(value, r.U); }
        else if(field==='C'){ r.C = toNum(value, r.C); }
        else if(field==='I'){ r.I = toNum(value, r.I); }
        else if(field==='DIS'){ r.DIS = toNum(value, r.DIS); }
        else if(field==='Ecut'){ r.Ecut = toNum(value, r.Ecut); }
        render();
      });
    });

    tr.querySelector('[data-sistema]')?.addEventListener('change', (ev)=>{
      applySistema(r, ev.target.value);
      render();
    });

    tr.querySelector('[data-controllo]')?.addEventListener('change', (ev)=>{
      r.controlType = ev.target.value || defaults.controlType;
      render();
    });

    tr.querySelector('[data-exposure]')?.addEventListener('change', (ev)=>{
      r.exposureTime = ev.target.value || defaults.exposureTime;
      render();
    });

    tr.querySelector('[data-qty]')?.addEventListener('change', (ev)=>{
      applyQuantity(r, ev.target.value);
      render();
    });

    tr.querySelector('[data-stato]')?.addEventListener('change', (ev)=>{
      r.statoFisico = ev.target.value;
      render();
    });

    tr.querySelector('[data-del]')?.addEventListener('click',()=>{ state.rows.splice(i,1); render(); });
    tb.appendChild(tr);
  });
  document.querySelector('#exportBtn').disabled = state.rows.length===0;
}

function badge(text, cls){
  const classes = {
    irr:'b-irr',
    unc:'b-unc',
    sup:'b-sup',
    elev:'b-elev',
    grave:'b-grave'
  };
  const css = classes[cls] || classes.irr;
  const safe = escapeHtml(text).replace(/\n/g, '<br/>');
  return `<span class="badge ${css}">${safe}</span>`;
}

function toNum(v, def){ v = v.replace?.(',', '.') ?? v; const n=parseFloat(v); return isFinite(n)?n:def; }
function round(n,d=2){ const p=10**d; return Math.round(n*p)/p; }
function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }
function classifyRisk(value){
  const r = isFinite(value) ? value : 0;
  const found = RISK_CLASSES.find(cls=>cls.test(r));
  if(found){ return found; }
  return RISK_CLASSES[0];
}
function escapeHtml(s){ return String(s).replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;","\u003e":"&gt;"}[c]||c)); }

function buildOptions(options, selected){
  return options.map(opt=>`<option value="${opt.value}"${opt.value===selected?' selected':''}>${opt.label}</option>`).join('');
}

function getSistemaOption(value){ return SISTEMA_OPTIONS.find(opt=>opt.value===value); }
function getControlOption(value){ return CONTROL_TYPE_OPTIONS.find(opt=>opt.value===value); }
function getExposureOption(value){ return EXPOSURE_TIME_OPTIONS.find(opt=>opt.value===value); }
function getQuantityOption(value){ return QUANTITY_OPTIONS.find(opt=>opt.value===value); }

function computeDefaultI(sistema, qtyBand){
  const base = getSistemaOption(sistema)?.baseIndex;
  const inc = getQuantityOption(qtyBand)?.increment;
  const fallback = defaults.I;
  const calc = (base ?? fallback) + (inc ?? 0);
  return round(calc, 2);
}

function applySistema(row, value){
  row.sistema = value || defaults.sistema;
  if(!row.qtyBand){
    row.qtyBand = defaults.qtyBand;
    row.qty = getQuantityOption(row.qtyBand)?.label ?? row.qtyBand;
  }
  row.I = computeDefaultI(row.sistema, row.qtyBand);
}

function applyQuantity(row, value){
  row.qtyBand = value || defaults.qtyBand;
  row.qty = getQuantityOption(row.qtyBand)?.label ?? row.qtyBand;
  if(!row.sistema){
    row.sistema = defaults.sistema;
  }
  row.I = computeDefaultI(row.sistema, row.qtyBand);
}

// =================== EXPORT EXCEL ===================
async function downloadBlob(blob, filename){
  if(window.navigator?.msSaveOrOpenBlob){
    window.navigator.msSaveOrOpenBlob(blob, filename);
    return;
  }
  const urlFactory = window.URL || window.webkitURL;
  if(urlFactory?.createObjectURL){
    const url = urlFactory.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.rel = 'noopener';
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>{ try{ urlFactory.revokeObjectURL(url); }catch(e){} }, 1200);
    return;
  }
  await new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const a = document.createElement('a');
        a.href = reader.result;
        a.download = filename;
        a.rel = 'noopener';
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        a.remove();
        resolve();
      }catch(err){
        reject(err);
      }
    };
    reader.onerror = () => reject(reader.error || new Error('Browser non supporta download di Blob.'));
    reader.readAsDataURL(blob);
  });
}

function rowsToCsv(rows){
  if(!rows.length) return '';
  const headers = Object.keys(rows[0]);
  const esc = (val)=>{
    if(val===null || val===undefined) return '';
    const str = String(val).replace(/\r?\n/g,' ');
    return /[";,]/.test(str) ? '"'+str.replace(/"/g,'""')+'"' : str;
  };
  const lines = [headers.join(';')];
  for(const row of rows){
    lines.push(headers.map(h=>esc(row[h])).join(';'));
  }
  return lines.join('\r\n');
}

async function exportExcel(){
  let flatRows;
  try{
    if(!state.rows.length){
      showAlert('Nessun dato da esportare. Carica o genera prima delle righe.');
      return;
    }
    const XLSX = await ensureXlsx();
    if(!XLSX?.utils){
      throw new Error('Libreria SheetJS caricata ma priva delle utilit√† attese.');
    }
    flatRows = state.rows.map(r=>({
      File:r.file,
      Nome_commerciale:r.nome,
      Stato_fisico: STATO_FISICO_OPTIONS.find(opt=>opt.value===r.statoFisico)?.label ?? r.statoFisico,
      Hcodes:r.hcodes.join(';'),
      SCORE:r.SCORE,
      Sistema: getSistemaOption(r.sistema)?.label ?? r.sistema,
      Tipologia_di_controllo: getControlOption(r.controlType)?.label ?? r.controlType,
      Tempo_di_esposizione: getExposureOption(r.exposureTime)?.label ?? r.exposureTime,
      Quantit√†_in_uso: getQuantityOption(r.qtyBand)?.label ?? r.qty,
      Indice_D:r.D,
      Indice_U:r.U,
      Indice_C:r.C,
      Indice_I:r.I,
      Distanza_DIS:r.DIS,
      E_inal:r.Einal,
      Ecut:r.Ecut,
      R_inal:r.Rinal,
      R_cut:r.Rcut,
      R_tot:r.Rtot,
      Giudizio:r.Giudizio
    }));
    const ws = XLSX.utils.json_to_sheet(flatRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'MOVARISCH');
    // Fallback robusto via Blob per ambienti con CSP restrittive
    const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    const blob = new Blob([wbout], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    await downloadBlob(blob, 'MOVARISCH_autoestratto.xlsx');
  } catch(err){
    console.error(err);
    if(flatRows?.length){
      try{
        const csv = rowsToCsv(flatRows);
        const csvBlob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        await downloadBlob(csvBlob, 'MOVARISCH_autoestratto.csv');
        showAlert('Export Excel non disponibile. √à stato generato un CSV di fallback. Dettaglio: ' + (err && err.message ? err.message : err));
        return;
      }catch(csvErr){
        console.error(csvErr);
      }
    }
    showAlert('Export Excel fallito: ' + (err && err.message ? err.message : err));
  }
}

// =================== EVENTS ===================
const pdfInput = document.querySelector('#pdfInput');
const parseBtn = document.querySelector('#parseBtn');
const exportBtn = document.querySelector('#exportBtn');
const clearBtn = document.querySelector('#clearBtn');
const testBtn = document.querySelector('#testBtn');

pdfInput.addEventListener('change', (e)=>{
  state.files = Array.from(e.target.files||[]);
  parseBtn.disabled = state.files.length===0;
});

parseBtn.addEventListener('click', async ()=>{
  if(!state.files.length) return;
  clearAlert();
  state.rows = [];
  try{
    for(const file of state.files){
      const text = await pdfToText(file);
      let hcodes = findH(text);
      if(!hcodes.length && guessUV(file.name, text)) hcodes = UV_FALLBACK.slice();
      let score = hcodes.length ? pickScore(hcodes) : 0;
      const productName = extractProductName(text) || file.name.replace(/\.pdf$/i, '');
      const row = {
        file: file.name,
        nome: productName,
        statoFisico: defaults.statoFisico,
        hcodes,
        SCORE: score,
        sistema: defaults.sistema,
        controlType: defaults.controlType,
        exposureTime: defaults.exposureTime,
        qtyBand: defaults.qtyBand,
        qty: getQuantityOption(defaults.qtyBand)?.label ?? defaults.qtyBand,
        D: defaults.D, U: defaults.U, C: defaults.C,
        I: computeDefaultI(defaults.sistema, defaults.qtyBand),
        DIS: defaults.DIS, Ecut: defaults.Ecut,
        Einal: 0, Rinal: 0, Rcut: 0, Rtot: 0, Giudizio: '', GiudizioClass: ''
      };
      state.rows.push(row);
    }
    render();
  }catch(err){
    showAlert('Errore durante il parsing PDF: '+ (err && err.message ? err.message : err));
  }
});

exportBtn.addEventListener('click', exportExcel);
clearBtn.addEventListener('click', ()=>{ state.rows=[]; render(); clearAlert(); });

// =================== TEST CASE ===================
const TEST_PDF_BASE64 = 'JVBERi0xLjQKJeLjz9MKMSAwIG9iago8PC9UeXBlL1BhZ2VzL0tpZHMgWzIgMCBSXS9Db3VudCAxPj4KZW5kb2JqCjIgMCBvYmoKPDwvVHlwZS9QYWdlL1BhcmVudCAxIDAgUi9NZWRpYUJveFswIDAgNTk1IDg0Ml0vUmVzb3VyY2VzPDwvUHJvY1svUERGIC9UZXh0XSA+Pi9Db250ZW50cyAzIDAgUj4+CmVuZG9iajozIDAgb2JqCjw8L0xlbmd0aCAxMTM+PgpzdHJlYW0KQlQKL0YxIDEyIFRmCjEwMCA3MDAgVGQKKC9IQzMxNyBjYXQuMUIgSDMzNSkgVGoKRVQKZW5kc3RyZWFtCmVuZG9iagp4cmVmCjAgNAowMDAwMDAwMDAwIDY1NTM1IGYNCjAwMDAwMDA5NjMgMDAwMDAgbg0KMDAwMDAwMDEzNiAwMDAwMCBuDQowMDAwMDAwMjc0IDAwMDAwIG4NCnRyYWlsZXIKPDwvU2l6ZSA0IC9Sb290IDEgMCBSPj4Kc3RhcnR4cmVmCjM5OQolJUVPRgo=';

async function runTest(){
  clearAlert();
  try{
    await ensurePdfJs();
    const bin = atob(TEST_PDF_BASE64);
    const bytes = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
    const testFile = new File([bytes], 'TEST_H317_H335.pdf', {type:'application/pdf'});
    const text = await pdfToText(testFile);
    const productName = extractProductName(text) || 'Esempio ‚Äì Test Parser';
    const h = findH(text);
    state.rows = [{
      file: testFile.name,
      nome: productName,
      statoFisico: defaults.statoFisico,
      hcodes: h,
      SCORE: pickScore(h),
      sistema: defaults.sistema,
      controlType: defaults.controlType,
      exposureTime: defaults.exposureTime,
      qtyBand: defaults.qtyBand,
      qty: getQuantityOption(defaults.qtyBand)?.label ?? defaults.qtyBand,
      D: defaults.D, U: defaults.U, C: defaults.C,
      I: computeDefaultI(defaults.sistema, defaults.qtyBand), DIS: defaults.DIS, Ecut: defaults.Ecut,
      Einal:0,Rinal:0,Rcut:0,Rtot:0,Giudizio:'', GiudizioClass:''
    }];
    render();
    showAlert('Test eseguito: libreria PDF.js caricata e parsing OK. H trovate: '+h.join('; '));
  }catch(e){
    showAlert('Test fallito: '+(e && e.message ? e.message : e));
  }
}

document.querySelector('#testBtn').addEventListener('click', runTest);
</script>
</body>
</html>
